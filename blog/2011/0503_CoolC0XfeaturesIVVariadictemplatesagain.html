<h1>Cool C++0X features IV: Variadic templates again<a name="coolc0xfeaturesivvariadictemplatesagain"></a></h1>
<p>Last time we finally solved the varargs problem. Let&rsquo;s review what we learned:
* Variadic templates let us create something receiving a variable set of arguments
* We can process the head of that set, then recursively process the tail
* It adds weird new syntax
    + When declaring typename&hellip; T you are saying &ldquo;here goes a list of types&rdquo;
    + When declaring T&hellip; t you are saying t is a list of objects with different type
    + When you write t&hellip;, you are saying &ldquo;expand the list of arguments&rdquo;
* It&rsquo;s type safe
* It&rsquo;s very neat to confuse your coworkers</p>
<p>So, what can we do with it besides implementing our own version of printf? Let&rsquo;s do something better, let&rsquo;s try adding up a list of numbers to start flexing our variadic templatefooness (?).</p>
<p>What&rsquo;s the usual way of adding a list of numbers? In templates, that is. We need something like this:</p>
<pre style="display: inline-block; border: 1px solid red;">sum (H:T) &lt;- H + sum(T)
sum () &lt;- 0
</pre>
<p>Of course, in C++ templates you don&rsquo;t have values, you just have types. We could implement it like this (if this looks like a new language you may want to check my <a href="/search/label/Series%3A%20Template%20Metaprogramming">template metaprogramming series</a>):</p>
<pre lang="c++" style="display: inline-block; border: 1px solid red;">#include &amp;lt;iostream&amp;gt;
struct Nil{};
template &amp;lt;typename H, typename T=Nil&amp;gt; struct Lst {
    typedef H Head;
    typedef T Tail;
};
template &amp;lt;
        template&amp;lt;typename A, typename B&amp;gt; class Op,
        typename Head,
        typename Lst&amp;gt;
struct intForeach
{
    typedef typename intForeach
        &amp;lt; Op, typename Lst::Head, typename Lst::Tail &amp;gt;::result Next;
    typedef typename Op&amp;lt; Head, Next &amp;gt;::result result;
};
template &amp;lt;
        template&amp;lt;typename A, typename B&amp;gt; class Op,
        typename Head&amp;gt;
struct intForeach &amp;lt;Op, Head, Nil&amp;gt;
{
    typedef Head result;
};
template &amp;lt;
        typename Lst,
        template&amp;lt;typename A,
        typename B&amp;gt;
        class Op&amp;gt;
struct Reduce
{
    typedef typename intForeach
        &amp;lt; Op, typename Lst::Head, typename Lst::Tail &amp;gt;::result result;
};
template &amp;lt;int N&amp;gt; struct Num {
    const static int value = N;
};
template &amp;lt;typename A, typename B&amp;gt; struct Sum {
    static const int r = A::value + B::value;
    typedef Num&amp;lt;r&amp;gt; result;
};
int main() {
    std::cout &amp;lt;&amp;lt; Reduce&amp;lt;
        Lst&amp;lt;Num&amp;lt;2&amp;gt;, Lst&amp;lt;Num&amp;lt;4&amp;gt;, Lst&amp;lt;Num&amp;lt;6&amp;gt;, Lst&amp;lt; Num&amp;lt;8&amp;gt; &amp;gt; &amp;gt; &amp;gt; &amp;gt;,
        Sum &amp;gt;::result::value &amp;lt;&amp;lt; &quot;n&quot;;
    return 0;
}
</pre>
<p>Nothing too fancy, plain old recursion with a sum. Yet it&rsquo;s quite verbose, can we make this a little bit more terse and, hopefully, more clear? Yes, we can. Take a look at that Lst, Lst&lt;&hellip;&gt; It sucks. And it&rsquo;s the perfect place to use variadic templates, we just need to construct a structure getting a list of ints, like this:</p>
<pre lang="c++" style="display: inline-block; border: 1px solid red;">template &amp;lt;
    // The operation we wish to apply
    template&amp;lt;typename A, typename B&amp;gt; class Op,
    // Current element to process
    class H,
    // All the rest
    class&hellip; T&amp;gt;
struct Reduce_V
{
    // TODO
}
</pre>
<p>That one should look familiar from last time article. Now, to implement a reduce operation we need to operate the current element with the result of reducing the tail, so we have to do something like this:</p>
<pre lang="c++" style="display: inline-block; border: 1px solid red;">// Remember how T&hellip; means to expand T for the next instance
    typedef typename Reduce_V&amp;lt;Op, T&hellip;&amp;gt;::result Tail_Result
</pre>
<p>There&rsquo;s something missing. Can you see what? The ending condition, of course. Let&rsquo;s add it and we&rsquo;ll get something like this:</p>
<pre lang="c++" style="display: inline-block; border: 1px solid red;">template &amp;lt;
        // The operation we wish to apply
        template&amp;lt;typename A, typename B&amp;gt; class Op,
        // All the rest
        class&hellip; T&amp;gt;
struct Reduce_V
{
};
template &amp;lt;
        // The operation we wish to apply
        template&amp;lt;typename A, typename B&amp;gt; class Op,
        // All the rest
        class H&amp;gt;
struct Reduce_V&amp;lt;Op, H&amp;gt;
{
    typedef H result;
};
template &amp;lt;
        // The operation we wish to apply
        template&amp;lt;typename A, typename B&amp;gt; class Op,
        // Current element to process
        class H,
        // All the rest
        class&hellip; T&amp;gt;
struct Reduce_V&amp;lt;Op, H, T&hellip;&amp;gt;
{
        // Remember how T&amp;hellip; means to expand T for the next instance
   typedef typename Reduce_V&amp;lt;Op, T&hellip;&amp;gt;::result Tail_Result;
   // Reduce current value with the next in line
   typedef typename Op&amp;lt;H, Tail_Result&amp;gt;::result result;
};
</pre>
<p>And using it is very simple too:</p>
<pre lang="c++" style="display: inline-block; border: 1px solid red;">std::cout &amp;lt;&amp;lt; Reduce_V&amp;lt; Sum, Num&amp;lt;1&amp;gt;, Num&amp;lt;2&amp;gt;, Num&amp;lt;3&amp;gt;, Num&amp;lt;4&amp;gt;&amp;gt;::result::value &amp;lt;&amp;lt; &quot;n&quot;;
</pre>
<p>Next time we&rsquo;ll see another example for variadic templates and a new C++0x feature.</p>
<hr />
<h2>In reply to <a href="">this post</a>, <a href="">Chaitanya</a> commented @ 2013-09-06T22:10:04.000+02:00:<a name="inreplytothispostchaitanyacommented20130906t221004.0000200"></a></h2>
<p>Thanks for all the C++ posts. They are quite informative, really appreciate the C++ blog series :)</p>
<p>Original <a href="/blog/2011/0503_CoolC0XfeaturesIVVariadictemplatesagain.html">published here</a>.</p>
<hr />
<h2>In reply to <a href="">this post</a>, <a href="/blog_md">nicolasbrailo</a> commented @ 2013-09-06T22:42:15.000+02:00:<a name="inreplytothispostnicolasbrailoblog_mdcommented20130906t224215.0000200"></a></h2>
<p>Glad you find them useful Chaitanya, thanks for the feedback</p>
<p>Original <a href="/blog/2011/0503_CoolC0XfeaturesIVVariadictemplatesagain.html">published here</a>.</p>